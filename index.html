<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Test coverage on Dynamic Lazy Loading JavaScript</title>

    <meta name="description" content="A framework for easily creating beautiful presentations using HTML">
    <meta name="author" content="Ricky Chien">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/moon.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
          <h2 style="text-overflow: normal;">Test coverage on <br>Dynamic Lazy Loading JavaScript</h2>
          <p>
            <small>Created by <a href="mailto:ricky060709@gmail.com">Ricky Chien</a></small>
          </p>
        </section>

        <section>
          <section>
            <h2>Test coverage</h2>
            <aside class="notes">
              首先是Test Coverage
            </aside>
          </section>

          <section>
            <h2>Why we need test coverage?</h2>
            <div class="fragment">
              <p>For better software quality, we need to write tests</p>
              <p>Coverage tool can give us a statistics report after testing</p>
              <img src="assets/coverage-report.png" alt="coverage report">
              <small><p>Blanket.js - JavaScript test coverage tool</p></small>
            </div>
            <aside class="notes">
              為什麼我們需要Test Coverage？
              一般的programmer會寫測試來確保程式的品質，
              不過寫好了測試後卻無法得知寫的測試是否有完整的涵蓋系統，這時programmer可以藉由
              coverage tool來取得測試覆蓋的統計資料，進一步了解撰寫的測試涵蓋狀況。
            </aside>
          </section>
        </section>

        <section>
          <section>
            <h2>Web application</h2>
            <aside class="notes">
              接下來會開始介紹Web application
            </aside>
          </section>

          <section>
            <h2>Web is changing</h2>
            <ul>
              <li class="fragment"><p>Nowadays, web is going to become more complicated</p></li>
              <li class="fragment"><p>Client (Browser) can take more jobs than server</p></li>
            </ul>
            <div class="fragment">
              <img src="assets/gmail.png" alt="gmail" style="width: 680px; height: 400px;">
            </div>
            <aside class="notes">
              Web is changing。
              我們知道現今的Web已經變得越來越複雜。
              Browser端功能越來越強大，可以幫助Server分擔許多複雜的任務。
              Gmail就是一個最著名的例子，有用過的人都知道，在使用Gmail時不像在瀏覽一般網頁，而更像是在使用一般桌面應用程式。
              也因此，我們將它稱之為Web應用程式。
            </aside>
          </section>

          <section>
            <h2>Web application depends on network</h2>
            <br>
            <img src="assets/browser-network.png" alt="browser network">
            <aside class="notes">
              另外一方面，Web應用程式與一般桌面應用程式不同的地方在於，他非常依賴網路，甚至連背後的原始碼模組也都是經由網路下載的。
            </aside>
          </section>

          <section>
            <h2>Dynamic lazy loading</h2>
            <img class="fragment" src="assets/dynamic-loading.png" alt="dynamic lazy loading">
            <aside class="notes">
              為了要提升網路速度，Dynamic lazy loading的概念被提了出來。中文稱為動態載入。
              左方圖中，一般JavaScript原始碼都是使用HTML script語法載入。
              不過我們其實可以透過JavaScript的邏輯來判斷在適當的時機載入另一份JavaScript，以達成動態載入。
              如此一來可以有效降低網路流量，提升使用者體驗品質。
            </aside>
          </section>
        </section>

        <section>
          <section>
            <h2>Background</h2>
            <aside class="notes">
              接下來是與本研究相關的Background
            </aside>
          </section>

          <section>
            <h2>Source instrumentation</h2>
            <img src="assets/before-instrument.png" alt="before instrument"></img>
            <p><small>Before</small></p>
            <img src="assets/after-instrument.png" alt="after instrument"></img>
            <p><small>After</small></p>
            <aside class="notes">
              首先，code coverage統計程式碼覆蓋率的背後原理主要是透過source instrumentation，我們簡稱instrumentation。
              instrumentation是一種在不影響原程式行為的狀況下對原始碼進行增修，然後達成記錄程式走訪行為的目的。
              直接看範例圖，原本的程式碼如上圖，經過instrumentation之後，下圖的程式碼新增了額外的變數，用來記錄原始碼的走訪過程。
            </aside>
          </section>

          <section>
            <h2>Coverage mechanism in web</h2>
            <p>Browser instrumentation / Server instrumentation</p>
            <aside class="notes">
              接下來讓我們分析一下在Web上的code coverage實作方式，主要可以分為兩種方式 - 
              Browser instrumentation 與 Server instrumentation。
            </aside>
          </section>

          <section>
            <h2>Browser instrumentation</h2>
            <img src="assets/mechanism1-client-server.png" alt=""></img>
            <aside class="notes">
              Browser instrumentation即為在瀏覽器上做instrument。如圖中所見，一般測試環境的背後須啟動一個server，
            </aside>
          </section>

          <section>
            <h2>Server instrumentation</h2>
            <img src="assets/mechanism2-client-server.png" alt="browser test runner"></img>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h2>If situtaion is more complicated</h2>
            <p>Sometimes we need to interact with a real server</p>
            <img src="assets/instrumentation-server-problem.png"></img>
            <aside class="notes">
              
            </aside>
          </section>
        </section>

        <section>
          <section>
            <h2>Issue - Zero coverage</h2>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h2>Case 1</h2>
            <div>
              <p>Firefox OS email app should be covered 21 modules</p>
              <img src="assets/ffos-email-wrong.png" alt="ffox email wrong">
            </div>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h2>Case 2</h2>
            <div>
              <img src="assets/lazyload-sample.png" alt="lazyload sample">
              <a href="http://rickychien.github.io/lazyload-sample/old/">Lazyload-sample</a>
            </div>
            <aside class="notes">
              
            </aside>
          </section>
        </section>

        <section>
          <section>
            <h2>Analysis</h2>
            <p>Analyze web dynamic lazy loading approachs</p>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h2>Script Loading - HTML Script</h2>
            <br>
            <pre><code data-trim contenteditable>
&lt;script src=&quot;path-to/script.js&quot;&gt;&lt;/script&gt;
            </code></pre>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h2>Script Loading - XHR (Ajax)</h2>
            <br>
            <pre><code data-trim contenteditable>
var xhr = new XMLHttpRequest();
xhr.open('GET', 'path-to/script.js'); // Assign script url
xhr.onload = function (script) {
  eval(script); // Execute script
};
xhr.send();
            </code></pre>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h2>Script Loading - Document.write</h2>
            <br>
            <pre><code data-trim contenteditable>
document.write('<script src="path-to/script.js"></script>');
            </code></pre>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h2>Script Loading - DOM modification API</h2>
            <br>
            <p>appendChild / insertBefore / replaceChild</p>
            <pre><code data-trim contenteditable>
var script = document.createElement("script");
script.src = url; // Assign script url

document.head.appendChild(script);
parentNode.insertBefore(script, node);
parentNode.replaceChild(script, oldNode);
            </code></pre>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h2>Script Loading - Function Wrapping</h2>
            <br>
            <p>Famous module loader library such as RequireJS using syntax :</p>
            <pre><code data-trim contenteditable>
require(["path-to/script.js"], function() {
  // This function is called after path-to/script.js has loaded.
});
            </code></pre>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h2>Summary</h2>
            <img style="width: 80%; height: 80%" src="assets/script-loading-analysis.png" alt="script loading analysis"></img>
          </section>
            <aside class="notes">
              
            </aside>
        </section>

        <section>
          <section>
            <h2>Method</h2>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h2>Browser Instrumentation Review</h2>
            <img src="assets/code-coverage-mechanism1.png" alt="code coverage mechanism 1"></img>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h2>Solution</h2>
            <img src="assets/solution-mechanism.png" alt="solution mechanism"></img>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h2>DOM modification API</h2>
            <p>Overwrite native appendChild / insertBefore / replaceChild</p>
            <br>
            <pre><code data-trim contenteditable>
var originalAppendChild = Element.prototype.appendChild;

Element.prototype.appendChild = function(newElement) {
    // Do our hack here
    return originalAppendChild.apply(this, args); // invoke native method
};
            </code></pre>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h2>XHR API</h2>
            <p>Overwrite native open method in XHR object</p>
            <br>
            <pre><code data-trim contenteditable>
var originalXHROpen = XMLHttpRequest.prototype.open;

XMLHttpRequest.prototype.open = function(method, url) {
  // Do our hack here
  return originalXHROpen.apply(this, args); // invoke native method
};
            </code></pre>
            <aside class="notes">
              
            </aside>
          </section>
        </section>

        <section>
          <section>
            <h2>Achievement</h2>
          </section>

          <section>
            <h3>A simple dynamic lazy loading website</h3>
            <br>
            <ul>
              <li><a href="http://rickychien.github.io/lazyload-sample/old/">Without support lazyload</a></li>
              <li><a href="http://rickychien.github.io/lazyload-sample/new/">With support lazyload</a></li>
            </ul>
            <aside class="notes">
              
            </aside>
          </section>

          <section>
            <h3>New feature has landed in Firefox OS</h3>
            <img src="assets/ffos-email-correct.png" alt="ffos email correct">
            <aside class="notes">
              
            </aside>
          </section>
        </section>

        <section>
          <h2>Conclusion</h2>
          <ul>
            <li class="fragment"><p>We demonstrated the zero coverage issue</p></li>
            <li class="fragment"><p>Analyzed code instrumentation mechanism and dynamic lazy loading schemes</p></li>
            <li class="fragment"><p>Proposed a solution to overwrite native Web APIs to addressing zero coverage issue</p></li>
            <li class="fragment"><p>Experiment was successful so that can cover dynamic lazy loading scripts</p></li>
            <li class="fragment"><p>Solution is safe that even integrated into FFOS testing framework</p></li>
            <li class="fragment"><p>New feature will land into Blanket.js</p></li>
          </ul>
          <aside class="notes">
            
          </aside>
        </section>

        <section>
          <h1>Q &amp; A</h1>
        </section>

      </div>

    </div>
    <span class="slidenumber"></span>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>

    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Parallax scrolling
        // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
        // parallaxBackgroundSize: '2100px 900px',

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });

      function slidenumber(event) {
        //var totalslides = document.querySelectorAll( '.reveal .slides section:not(.stack)' ).length;
        var current_slide = 0;

        var horizontal_slides = document.querySelectorAll( '.reveal .slides>section' );
        for (var i = 0; i < event.indexh; i++) {
          // get subslides
          var subslides = horizontal_slides[i].querySelectorAll('section');

          // if subslides.length is 0, add 1 for horizontal slide, else add subslides.length
          current_slide += (subslides.length === 0) ? 1 : subslides.length;
        }

        current_slide += event.indexv + 1;
        return current_slide.toString(); // + " / " + totalslides.toString();
      }

      Reveal.addEventListener('slidechanged', function(event) {
        document.querySelector('.slidenumber').innerHTML = slidenumber(event);
      });

      Reveal.addEventListener('ready', function(event) {
        var div = document.querySelector('.reveal.center'),
            aside = document.createElement('aside');
        aside.setAttribute('class', 'controls slidenumber');
        aside.setAttribute('style', 'display: block; left: 10px; right: initial; bottom: -30px; text-align: center; color: rgb(47, 210, 233);');
        aside.innerHTML = slidenumber(event);
        div.appendChild(aside);
      });

    </script>

  </body>
</html>
